
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>db: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">myapp/db/connectionPostgres.go (0.0%)</option>
				
				<option value="file1">myapp/db/connectionRedis.go (0.0%)</option>
				
				<option value="file2">myapp/docs/docs.go (100.0%)</option>
				
				<option value="file3">myapp/handlers/handler.go (33.8%)</option>
				
				<option value="file4">myapp/main.go (0.0%)</option>
				
				<option value="file5">myapp/middleware/middleware.go (65.0%)</option>
				
				<option value="file6">myapp/utils/hash.go (88.9%)</option>
				
				<option value="file7">myapp/utils/user.go (73.2%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package db

import (
        "context"
        "fmt"
        "os"

        "github.com/jackc/pgx/v4/pgxpool"
        "github.com/joho/godotenv"
)

func ConnectDB() (*pgxpool.Pool, error) <span class="cov0" title="0">{
        if err := godotenv.Load(".env"); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">psqlInfo := fmt.Sprintf("host=%s port=%s user=%s "+"password=%s dbname=%s sslmode=disable",
                os.Getenv("DBHOST"), os.Getenv("DBPORT"), os.Getenv("DBUSER"),
                os.Getenv("DBPASSWORD"), os.Getenv("DBNAME"))

        dbPool, err := pgxpool.Connect(context.Background(), psqlInfo)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return dbPool, nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package db

import (
        "os"
        "time"

        "github.com/gomodule/redigo/redis"
        "github.com/joho/godotenv"
)

func ConnectRedis() (*redis.Pool, error) <span class="cov0" title="0">{
        if err := godotenv.Load(".env"); err != nil </span><span class="cov0" title="0">{
                return &amp;redis.Pool{}, err
        }</span>

        <span class="cov0" title="0">return &amp;redis.Pool{
                MaxIdle:     10,
                IdleTimeout: 240 * time.Second,
                // Dial or DialContext must be set. When both are set, DialContext takes precedence over Dial.
                Dial: func() (redis.Conn, error) </span><span class="cov0" title="0">{
                        return redis.Dial(os.Getenv("REDISPROTOCOL"), os.Getenv("REDISHOST")+":"+os.Getenv("REDISPORT"))
                }</span>,
        }, nil
}
</pre>
		
		<pre class="file" id="file2" style="display: none">// Package docs GENERATED BY THE COMMAND ABOVE; DO NOT EDIT
// This file was generated by swaggo/swag
package docs

import "github.com/swaggo/swag"

const docTemplate = `{
    "schemes": {{ marshal .Schemes }},
    "swagger": "2.0",
    "info": {
        "description": "{{escape .Description}}",
        "title": "{{.Title}}",
        "contact": {},
        "license": {
            "name": "\"\""
        },
        "version": "{{.Version}}"
    },
    "host": "{{.Host}}",
    "basePath": "{{.BasePath}}",
    "paths": {
        "/": {
            "get": {
                "description": "Get your home page.",
                "produces": [
                    "application/json"
                ],
                "summary": "Get Home Page.",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "401": {
                        "description": "ERROR: User is unauthorized",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "500": {
                        "description": "Internal server error",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    }
                }
            }
        },
        "/login": {
            "post": {
                "description": "Check login and gives session ID.",
                "produces": [
                    "application/json"
                ],
                "summary": "Login in account.",
                "parameters": [
                    {
                        "description": "Data for user",
                        "name": "data",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/models.User"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Successful login",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "400": {
                        "description": "Invalid request body",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "401": {
                        "description": "Wrong password",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "404": {
                        "description": "User not found",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "500": {
                        "description": "Internal server error",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    }
                }
            }
        },
        "/logout": {
            "delete": {
                "description": "Delete session from DB.",
                "produces": [
                    "application/json"
                ],
                "summary": "Logout.",
                "responses": {
                    "200": {
                        "description": "OK: User is logged out",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "500": {
                        "description": "Internal server error",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    }
                }
            }
        },
        "/movieCompilations": {
            "get": {
                "description": "Get movie compilations for user.",
                "produces": [
                    "application/json"
                ],
                "summary": "Get Movie Compilations.",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "401": {
                        "description": "ERROR: User is unauthorized",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "500": {
                        "description": "Internal server error",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    }
                }
            }
        },
        "/signup": {
            "post": {
                "description": "Create new user in database with validation.",
                "produces": [
                    "application/json"
                ],
                "summary": "Creates new user.",
                "parameters": [
                    {
                        "description": "Data for user",
                        "name": "data",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/models.User"
                        }
                    }
                ],
                "responses": {
                    "201": {
                        "description": "OK: User created",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "400": {
                        "description": "Invalid request body",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    },
                    "500": {
                        "description": "Internal server error",
                        "schema": {
                            "$ref": "#/definitions/handlers.Response"
                        }
                    }
                }
            }
        }
    },
    "definitions": {
        "handlers.Response": {
            "type": "object",
            "properties": {
                "message": {
                    "type": "string"
                },
                "status": {
                    "type": "integer"
                }
            }
        },
        "models.User": {
            "type": "object",
            "properties": {
                "email": {
                    "type": "string",
                    "example": "email"
                },
                "id": {
                    "type": "integer"
                },
                "password": {
                    "type": "string",
                    "minLength": 8,
                    "example": "password"
                },
                "salt": {
                    "type": "string"
                },
                "username": {
                    "type": "string",
                    "example": "name"
                }
            }
        }
    }
}`

// SwaggerInfo holds exported Swagger Info so clients can modify it
var SwaggerInfo = &amp;swag.Spec{
        Version:          "1.0",
        Host:             "movie-space.ru:1323",
        BasePath:         "/api/v1/",
        Schemes:          []string{"http"},
        Title:            "Movie Space API",
        Description:      "This is API server for Movie Space website.",
        InfoInstanceName: "swagger",
        SwaggerTemplate:  docTemplate,
}

func init() <span class="cov8" title="1">{
        swag.Register(SwaggerInfo.InstanceName(), SwaggerInfo)
}</span>
</pre>
		
		<pre class="file" id="file3" style="display: none">package handlers

import (
        "errors"
        "myapp/models"
        "myapp/utils"
        "net/http"
        "time"

        "github.com/gofrs/uuid"
        "github.com/gomodule/redigo/redis"

        _ "myapp/docs"

        "github.com/labstack/echo/v4"
)

type Response struct {
        Status  int    `json:"status"`
        Message string `json:"message"`
}

type ResponseName struct {
        Status int    `json:"status"`
        Name   string `json:"username"`
}

type ResponseMovieCompilations struct {
        Status           int                       `json:"status"`
        MovieCompilation []models.MovieCompilation `json:"moviesCompilation"`
}

// CreateUserHandler godoc
// @Summary Creates new user.
// @Description Create new user in database with validation.
// @Produce json
// @Param data body models.User true "Data for user"
// @Success         201 {object} Response "OK: User created"
// @Failure                400 {object} Response "Invalid request body"
// @Failure                500 {object} Response "Internal server error"
// @Router /signup [post]
func CreateUserHandler(dbPool *utils.UserPool, redisPool *redis.Pool) echo.HandlerFunc <span class="cov0" title="0">{
        return func(context echo.Context) error </span><span class="cov0" title="0">{
                user := models.User{}

                if err := context.Bind(&amp;user); err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov0" title="0">if err := utils.ValidateUser(&amp;user); err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusBadRequest, &amp;Response{
                                Status:  http.StatusBadRequest,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov0" title="0">isUnique, err := dbPool.IsUserUnique(user)
                if err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })

                }</span>

                <span class="cov0" title="0">if !isUnique </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusBadRequest, &amp;Response{
                                Status:  http.StatusBadRequest,
                                Message: "ERROR: Email is not unique",
                        })
                }</span>

                <span class="cov0" title="0">userID, err := dbPool.CreateUser(user)
                if err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov0" title="0">value, err := uuid.NewV4()
                if err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov0" title="0">cookie := &amp;http.Cookie{
                        Name:     "Session_cookie",
                        Value:    value.String(),
                        HttpOnly: true,
                        Expires:  time.Now().Add(time.Hour),
                        SameSite: 0,
                }

                context.SetCookie(cookie)

                connRedis := redisPool.Get()
                defer connRedis.Close()
                _, err = connRedis.Do("SET", value, userID, "EX", int64(time.Hour.Seconds()))
                if err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov0" title="0">return context.JSON(http.StatusCreated, &amp;Response{
                        Status:  http.StatusCreated,
                        Message: "OK: User created",
                })</span>
        }
}

// LoginUserHandler godoc
// @Summary Login in account.
// @Description Check login and gives session ID.
// @Produce json
// @Param data body models.User true "Data for user"
// @Success         200 {object} Response "Successful login"
// @Failure                400 {object} Response "Invalid request body"
// @Failure                401 {object} Response "Wrong password"
// @Failure                404 {object} Response "User not found"
// @Failure                500 {object} Response "Internal server error"
// @Router /login [post]
func LoginUserHandler(dbPool *utils.UserPool, redisPool *redis.Pool) echo.HandlerFunc <span class="cov0" title="0">{
        return func(context echo.Context) error </span><span class="cov0" title="0">{
                user := models.User{}
                if err := context.Bind(&amp;user); err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov0" title="0">userID, userExists, err := dbPool.IsUserExists(user)
                if err != nil </span><span class="cov0" title="0">{
                        if errors.Is(err, utils.ErrWrongPassword) </span><span class="cov0" title="0">{
                                return context.JSON(http.StatusUnauthorized, &amp;Response{
                                        Status:  http.StatusUnauthorized,
                                        Message: "ERROR: Wrong password",
                                })
                        }</span>

                        <span class="cov0" title="0">return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })</span>
                }

                <span class="cov0" title="0">if !userExists </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusNotFound, &amp;Response{
                                Status:  http.StatusNotFound,
                                Message: "ERROR: User not found",
                        })
                }</span>

                <span class="cov0" title="0">value, err := uuid.NewV4()
                if err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov0" title="0">cookie := http.Cookie{
                        Name:     "Session_cookie",
                        Value:    value.String(),
                        HttpOnly: true,
                        Expires:  time.Now().Add(time.Hour),
                        SameSite: 0,
                }

                context.SetCookie(&amp;cookie)

                connRedis := redisPool.Get()
                defer connRedis.Close()
                _, err = connRedis.Do("SET", value, userID, "EX", int64(time.Hour.Seconds()))
                if err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov0" title="0">return context.JSON(http.StatusOK, &amp;Response{
                        Status:  http.StatusOK,
                        Message: "OK: User can be logged in",
                })</span>
        }
}

// GetHomePageHandler godoc
// @Summary Get Home Page.
// @Description Get your home page.
// @Produce json
// @Success         200 {object} Response models.User.name
// @Failure                401 {object} Response "ERROR: User is unauthorized"
// @Failure                500 {object} Response "Internal server error"
// @Router / [get]
func GetHomePageHandler(dbPool *utils.UserPool) echo.HandlerFunc <span class="cov8" title="1">{
        return func(context echo.Context) error </span><span class="cov8" title="1">{
                userID, ok := context.Get("USER_ID").(int64)
                if !ok </span><span class="cov8" title="1">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: "ERROR: Session required",
                        })
                }</span>

                <span class="cov8" title="1">if userID == -1 </span><span class="cov8" title="1">{
                        return context.JSON(http.StatusUnauthorized, &amp;Response{
                                Status:  http.StatusUnauthorized,
                                Message: "ERROR: User is unauthorized",
                        })
                }</span>

                <span class="cov8" title="1">name, err := dbPool.GetUserName(userID)
                if err != nil </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov8" title="1">return context.JSON(http.StatusOK, &amp;ResponseName{
                        Status: http.StatusOK,
                        Name:   name,
                })</span>
        }
}

// LogoutHandler godoc
// @Summary Logout.
// @Description Delete session from DB.
// @Produce json
// @Success         200 {object} Response "OK: User is logged out"
// @Failure                500 {object} Response "Internal server error"
// @Router /logout [delete]
func LogoutHandler(redisPool *redis.Pool) echo.HandlerFunc <span class="cov8" title="1">{
        return func(ctx echo.Context) error </span><span class="cov8" title="1">{
                cookie, err := ctx.Cookie("Session_cookie")
                if err != nil </span><span class="cov8" title="1">{
                        return ctx.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov8" title="1">connRedis := redisPool.Get()
                defer connRedis.Close()
                _, err = connRedis.Do("DEL", cookie.Value)
                if err != nil </span><span class="cov0" title="0">{
                        return ctx.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: err.Error(),
                        })
                }</span>

                <span class="cov8" title="1">cookie.Expires = time.Now().AddDate(0, 0, -1)
                ctx.SetCookie(cookie)

                return ctx.JSON(http.StatusOK, &amp;Response{
                        Status:  http.StatusOK,
                        Message: "OK: User is logged out",
                })</span>
        }
}

// GetMovieCompilations godoc
// @Summary Get Movie Compilations.
// @Description Get movie compilations for user.
// @Produce json
// @Success         200 {object} Response models.MovieCompilation
// @Failure                401 {object} Response "ERROR: User is unauthorized"
// @Failure                500 {object} Response "Internal server error"
// @Router                 /movieCompilations [get]
func GetMovieCompilations() echo.HandlerFunc <span class="cov8" title="1">{
        return func(context echo.Context) error </span><span class="cov8" title="1">{
                userID, ok := context.Get("USER_ID").(int64)
                if !ok </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusInternalServerError, &amp;Response{
                                Status:  http.StatusInternalServerError,
                                Message: "ERROR: Session required",
                        })
                }</span>

                <span class="cov8" title="1">if userID == -1 </span><span class="cov0" title="0">{
                        return context.JSON(http.StatusUnauthorized, &amp;Response{
                                Status:  http.StatusUnauthorized,
                                Message: "ERROR: User is unauthorized",
                        })
                }</span>

                <span class="cov8" title="1">movieCompilations := []models.MovieCompilation{
                        {
                                Name: "Популярное",
                                Movies: []models.Movie{
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны1",
                                                Genre: "Фантастика1",
                                        },
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны2",
                                                Genre: "Фантастика2",
                                        },
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны3",
                                                Genre: "Фантастика3",
                                        },
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны4",
                                                Genre: "Фантастика4",
                                        },
                                },
                        },
                        {
                                Name: "Топ",
                                Movies: []models.Movie{
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны#1",
                                                Genre: "Фантастика",
                                        },
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны#2",
                                                Genre: "Фантастика",
                                        },
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны#3",
                                                Genre: "Фантастика",
                                        },
                                },
                        },
                        {
                                Name: "Семейное",
                                Movies: []models.Movie{
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны#1",
                                                Genre: "Фантастика",
                                        },
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны#2",
                                                Genre: "Фантастика",
                                        },
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны#3",
                                                Genre: "Фантастика",
                                        },
                                        {
                                                Img:   "star.png",
                                                Href:  "/",
                                                Name:  "Звездные войны4",
                                                Genre: "Фантастика4",
                                        },
                                },
                        },
                }

                return context.JSON(http.StatusOK, &amp;ResponseMovieCompilations{
                        Status:           http.StatusOK,
                        MovieCompilation: movieCompilations,
                })</span>

        }
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package main

import (
        "log"
        "myapp/db"
        "myapp/handlers"
        "myapp/middleware"
        "myapp/utils"

        "github.com/labstack/echo/v4"
        echoSwagger "github.com/swaggo/echo-swagger"

        _ "github.com/jackc/pgx/v4"
)

// @title Movie Space API
// @version 1.0
// @description This is API server for Movie Space website.
// @license.name  ""

// @host movie-space.ru:1323
// @BasePath /api/v1/
// @schemes http
func main() <span class="cov0" title="0">{
        dbPool, err := db.ConnectDB()
        if err != nil </span><span class="cov0" title="0">{
                log.Fatal(err)
        }</span>

        <span class="cov0" title="0">redisPool, err := db.ConnectRedis()
        if err != nil </span><span class="cov0" title="0">{
                log.Fatal(err)
        }</span>
        <span class="cov0" title="0">defer redisPool.Close()

        userPool := utils.UserPool{
                Pool: dbPool,
        }

        defer dbPool.Close()

        echoServ := echo.New()

        echoServ.Use(middleware.CheckAuthorization(redisPool))
        echoServ.Use(middleware.CORS())
        echoServ.GET("/swagger/*", echoSwagger.WrapHandler)

        echoServ.POST("/api/v1/signup", handlers.CreateUserHandler(&amp;userPool, redisPool))
        echoServ.POST("/api/v1/login", handlers.LoginUserHandler(&amp;userPool, redisPool))
        echoServ.DELETE("/api/v1/logout", handlers.LogoutHandler(redisPool))
        echoServ.GET("/api/v1/", handlers.GetHomePageHandler(&amp;userPool))

        echoServ.GET("/api/v1/movieCompilations", handlers.GetMovieCompilations())

        echoServ.Logger.Fatal(echoServ.Start(":1323"))</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package middleware

import (
        "net/http"
        "time"

        "github.com/labstack/echo/v4/middleware"
        "github.com/gomodule/redigo/redis"
        "github.com/labstack/echo/v4"
)

func CORS() echo.MiddlewareFunc <span class="cov0" title="0">{
        return middleware.CORSWithConfig(middleware.CORSConfig{
                AllowOrigins:     []string{"http://movie-space.ru:8080", "http://localhost:8080"},
                AllowHeaders:     []string{"Accept", "Cache-Control", "Content-Type", "X-Requested-With"},
                AllowCredentials: true,
                MaxAge:           84600,
        })
}</span>

func CheckAuthorization(redisPool *redis.Pool) echo.MiddlewareFunc <span class="cov8" title="1">{
        return func(next echo.HandlerFunc) echo.HandlerFunc </span><span class="cov8" title="1">{
                return func(ctx echo.Context) error </span><span class="cov8" title="1">{
                        cookie, err := ctx.Cookie("Session_cookie")
                        var userID int64
                        userID = -1
                        if err == nil </span><span class="cov8" title="1">{
                                connRedis := redisPool.Get()
                                defer connRedis.Close()
                                userID, err = redis.Int64(connRedis.Do("GET", cookie.Value))
                                if err != nil </span><span class="cov0" title="0">{
                                        cookie = &amp;http.Cookie{Expires: time.Now().AddDate(0, 0, -1)}
                                        ctx.SetCookie(cookie)
                                        ctx.Set("USER_ID", -1)
                                        return next(ctx)
                                }</span>
                        }
                        <span class="cov8" title="1">if err != nil </span><span class="cov0" title="0">{
                                cookie = &amp;http.Cookie{Expires: time.Now().AddDate(0, 0, -1)}
                                ctx.SetCookie(cookie)
                        }</span>

                        <span class="cov8" title="1">ctx.Set("USER_ID", userID)

                        return next(ctx)</span>
                }
        }
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package utils

import (
        "golang.org/x/crypto/bcrypt"
)

func HashAndSalt(pwd string, salt string) (string, error) <span class="cov8" title="1">{
        hash, err := bcrypt.GenerateFromPassword([]byte(pwd+salt), bcrypt.MinCost)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return string(hash), nil</span>
}

func ComparePasswords(hashedPwd string, salt string, plainPwd string) (bool, error) <span class="cov8" title="1">{
        byteHash := []byte(hashedPwd)
        err := bcrypt.CompareHashAndPassword(byteHash, []byte(plainPwd+salt))
        if err != nil </span><span class="cov8" title="1">{
                return false, err
        }</span>

        <span class="cov8" title="1">return true, nil</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package utils

import (
        "context"
        "myapp/models"
        "strings"
        "unicode"

        "github.com/driftprogramming/pgxpoolmock"
        "gopkg.in/validator.v2"

        "github.com/gofrs/uuid"
)

type UserPool struct {
        Pool pgxpoolmock.PgxPool
}

// Используется LoginUserHandler.
// Проверяет, что пользователь есть в базе данных.
func (dbPool *UserPool) IsUserExists(user models.User) (int64, bool, error) <span class="cov8" title="1">{
        var userID int64
        sql := "SELECT id, email, password, salt FROM users WHERE email=$1"
        rows, err := dbPool.Pool.Query(context.Background(), sql, user.Email)
        if err != nil </span><span class="cov0" title="0">{
                return userID, false, err
        }</span>

        // убедимся, что всё закроется при выходе из программы
        <span class="cov8" title="1">defer func() </span><span class="cov8" title="1">{
                rows.Close()
        }</span>()

        // Из базы пришел пустой запрос, значит пользователя в базе данных нет
        <span class="cov8" title="1">if !rows.Next() </span><span class="cov8" title="1">{
                return userID, false, nil
        }</span>

        <span class="cov8" title="1">var signInUser models.User
        err = rows.Scan(&amp;signInUser.ID, &amp;signInUser.Email, &amp;signInUser.Password, &amp;signInUser.Salt)

        userID = signInUser.ID
        // выход при ошибке
        if err != nil </span><span class="cov0" title="0">{
                return userID, false, err
        }</span>

        <span class="cov8" title="1">result, err := ComparePasswords(signInUser.Password, signInUser.Salt, user.Password)
        if err != nil </span><span class="cov0" title="0">{
                return userID, false, ErrWrongPassword
        }</span>

        <span class="cov8" title="1">result = result &amp;&amp; signInUser.Email == user.Email

        return userID, result, nil</span>
}

// Используется CreateUserHandler.
// email должен быть уникален
func (dbPool *UserPool) IsUserUnique(user models.User) (bool, error) <span class="cov8" title="1">{
        sql := "SELECT * FROM users WHERE email=$1"
        rows, err := dbPool.Pool.Query(context.Background(), sql, user.Email)

        if err != nil </span><span class="cov0" title="0">{
                return false, err
        }</span>

        <span class="cov8" title="1">defer func() </span><span class="cov8" title="1">{
                rows.Close()
        }</span>()

        <span class="cov8" title="1">if rows.Next() </span><span class="cov8" title="1">{ // Пользователь с таким email зарегистрирован
                return false, nil
        }</span>
        <span class="cov8" title="1">return true, nil</span>
}

// Используется CreateUserHandler.
// Создает пользователя
func (dbPool *UserPool) CreateUser(user models.User) (int64, error) <span class="cov0" title="0">{
        var userID int64

        salt, err := uuid.NewV4()
        if err != nil </span><span class="cov0" title="0">{
                return userID, err
        }</span>

        <span class="cov0" title="0">hashPassword, err := HashAndSalt(user.Password, salt.String())
        if err != nil </span><span class="cov0" title="0">{
                return userID, err
        }</span>

        <span class="cov0" title="0">sql := "INSERT INTO users(username, email, password, salt) VALUES($1, $2, $3, $4) RETURNING id"

        if err = dbPool.Pool.QueryRow(context.Background(), sql, user.Name, user.Email, hashPassword, salt).Scan(&amp;userID); err != nil </span><span class="cov0" title="0">{
                return userID, err
        }</span>

        <span class="cov0" title="0">return userID, nil</span>
}

func (dbPool *UserPool) GetUserName(userID int64) (string, error) <span class="cov8" title="1">{
        sql := "SELECT username FROM users WHERE id=$1"

        var name string
        err := dbPool.Pool.QueryRow(context.Background(), sql, userID).Scan(&amp;name)
        if err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov8" title="1">return name, nil</span>
}

func ValidateUser(user *models.User) error <span class="cov8" title="1">{
        user.Name = strings.TrimSpace(user.Name)
        if err := validator.Validate(user); err != nil </span><span class="cov8" title="1">{
                return err
        }</span>
        <span class="cov0" title="0">if err := ValidatePassword(user.Password); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">return nil</span>
}

func ValidatePassword(pass string) error <span class="cov8" title="1">{
        var (
                upp, low, num bool
                symbolsCount  uint8
        )

        for _, char := range pass </span><span class="cov8" title="1">{
                switch </span>{
                case unicode.IsUpper(char):<span class="cov8" title="1">
                        upp = true
                        symbolsCount++</span>
                case unicode.IsLower(char):<span class="cov8" title="1">
                        low = true
                        symbolsCount++</span>
                case unicode.IsNumber(char):<span class="cov8" title="1">
                        num = true
                        symbolsCount++</span>
                case unicode.IsPunct(char) || unicode.IsSymbol(char):<span class="cov8" title="1">
                        symbolsCount++</span>
                default:<span class="cov8" title="1">
                        return banErr</span>
                }
        }

        <span class="cov8" title="1">if !upp </span><span class="cov8" title="1">{
                return upErr
        }</span>
        <span class="cov8" title="1">if !low </span><span class="cov8" title="1">{
                return lowErr
        }</span>
        <span class="cov8" title="1">if !num </span><span class="cov8" title="1">{
                return numErr
        }</span>
        <span class="cov8" title="1">if symbolsCount &lt; 8 </span><span class="cov8" title="1">{
                return countErr
        }</span>

        <span class="cov8" title="1">return nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
